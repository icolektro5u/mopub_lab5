<!DOCTYPE html>
<!--
* @file index.html
*
* The main CloudSquare entry file. This will display the login box and/or log in the user automatically
-->
<html>
	<head>
		<meta name="viewport" content="width=320, user-scalable=no">
		<meta http-equiv="Content-type" content="text/html; charset=utf-8">
		<title>RestauRate</title>
		
		<!-- JQuery stuff -->
		<link rel="stylesheet" href="http://code.jquery.com/mobile/1.2.0/jquery.mobile-1.2.0.min.css">
		<script src="http://code.jquery.com/jquery-1.8.2.min.js"></script>
		<script src="http://code.jquery.com/mobile/1.2.0/jquery.mobile-1.2.0.min.js"></script>
		
		<!-- Raty Stuff -->
		<script type="text/javascript" src="demo/js/jquery.min.js"></script>
		<script type="text/javascript" src="lib/jquery.raty.min.js"></script>
		
		<script type="text/javascript" charset="utf-8" src="js/wormhole.js"></script>
		<!--  include all the required CBHelper libraries: XMLHttpRequest, md5, json and the MoSync specific helper -->
		<script type="text/javascript" charset="utf-8" src="js/CBHelper/md5.js"></script>
		<script type="text/javascript" charset="utf-8" src="js/CBHelper/json.js"></script>
		<script type="text/javascript" charset="utf-8" src="js/CBHelper/CBXMLHttpRequest.js"></script>
		<script type="text/javascript" charset="utf-8" src="js/CBHelper/CBHelper.js"></script>
		<script type="text/javascript" charset="utf-8" src="js/CBHelper/platforms/GenericHelper.js"></script>
		
		
		<script type="text/javascript">
		var helper;
		var rating1;
		var rating2;
		var rating3;
		
		document.addEventListener(
			"DOMContentLoaded",
			function() {
				
				// initialize a new MoSyncHelper object
				//var moSyncHelper = new MoSyncHelper();
				
				// First initialise the helper object with the code, secret code 
				// and the generic helper
				
				helper = new CBHelper("lab5_mopub14", "243cf93c71c270f90d7290e338d1e72e", new GenericHelper());
				// use the md5 library provided to set the password
				helper.setPassword(hex_md5("lo8604924%."));
				
				mosync.rlog("initialized");
				
			
				func();
				initialRatings();
				
				
				
				/*$.fn.raty.defaults.path = 'lib/img';
				
				
				$('.demo div').raty({
					half: true,
					score: function() {
						if($(this).attr('restName') == "Hankuk Food"){
							alert("Outside function:" + ' ' + rating1);
							return 1;
						}
					
						else if($(this).attr('restName') == "Nihon Diner"){
							return 2;
						}
						
						else if($(this).attr('restName') == "Zhongguo Restaurant"){
							return 3;
						}
						//return $(this).attr('data-number');
					},
					click: function(score){
						var name = $(this).attr('restName');
						addRating(score, name)}
				});*/
				
				
			},
			true
			
		);

		

		function searchScores(resp) {
			// uncomment next row to get entire string
			//alert(resp.outputString);   
			   
			if (resp.callStatus){       // if successful
				var sum = 0;
				var count = 0;
				for (index in resp.outputData){
					var user = resp.outputData[index];
					
					sum = sum + user.score;
					count = count + 1;
				}
				//alert (user.restaurant + ' ' + sum/count);
			}
			return sum/count;
		}

		function addRating(score, name) {
			
			mosync.rlog("Adding rating");
			if ( helper ) {
				// create an object to be inserted in our CloudBase instance,
				// e.g a firstName, lastName and title into a collection called ‘users’
				var dataObject = {
					"restaurant" : name,
					"score" : score
				};
				 // use the insertDocument method to send the call and insert the data
				// in the users collection then print out the response using the
				// outputString property of the CBHelperResponseInfo object

				helper.insertDocument("ratings", dataObject, null);
				
			} else {
				mosync.rlog("helper class not initialized");
			}
		}
		
		function func(){
			var searchCondition1 = { "restaurant" : "Hankuk Food" };
			var searchCondition2 = { "restaurant" : "Nihon Diner" };
			var searchCondition3 = { "restaurant" : "Zhongguo Restaurant" };
	
			// call the searchDocuments function
			helper.searchDocuments(searchCondition1,"ratings", 
				function(resp) {
					//alert(resp.outputString); 
					rating1 = searchScores(resp);
					alert("Inside funtion:" + ' ' + rating1);
				}
			);
			
			helper.searchDocuments(searchCondition2,"ratings", 
				function(resp) {
					rating2 = searchScores(resp);
				}
			);
			
			helper.searchDocuments(searchCondition3,"ratings", 
				function(resp) {
					rating3 = searchScores(resp);
			
				}
				
			);
			
		};
		
		function initialRatings() {
			$.fn.raty.defaults.path = 'lib/img';
			
			
				$('.demo div').raty({
					half: true,
					score: function() {
						if($(this).attr('restName') == "Hankuk Food"){
							alert("Outside function:" + ' ' + rating1);
							return 1;
						}
					
						else if($(this).attr('restName') == "Nihon Diner"){
							return 2;
						}
						
						else if($(this).attr('restName') == "Zhongguo Restaurant"){
							return 3;
						}
						//return $(this).attr('data-number');
					},
					click: function(score){
						var name = $(this).attr('restName');
						addRating(score, name)}
				});
		};
		</script>

	</head>
	
	<body>
		<div data-role="page" id="screen1" data-theme="b" >
		
		
        <div data-role="header">
            <h1>RestauRate</h1>
        </div><!-- /header -->
 
        <div id="div1" data-role="content">
        
			<div data-role="collapsible" data-collapsed="false" data-inset="false">
			   <h3>Hankuk Food</h3>
			   <img width="100%" src="http://tong.visitkorea.or.kr/enu/CU/rc/940268_1_6.jpg"/>
			   
				<div class="demo">
					<div id="number-callback-demo1" restName='Hankuk Food' data-number="3"></div>
				</div>
			   
			  <p>Description text</p>
			   <p>Location text</p>
			   <p>Price text</p>
			</div>
		
			<div data-role="collapsible" data-collapsed="false" data-inset="false">
			   <h3>Nihon Diner</h3>
			   <img width="100%" src="http://www.maff.go.jp/e/export/campaign/img/cuisine.jpg"/>
			   
			   <div class="demo">
					<div id="number-callback-demo2" restName='Nihon Diner' data-number="1"></div>
				</div>
				
			   <p>Description text</p>
			   <p>Location text</p>
			   <p>Price text</p>
			</div>
		
			<div data-role="collapsible" data-collapsed="false" data-inset="false">
			   <h3>Zhongguo Restaurant</h3>
			   <img width="100%" src="http://jacquelinewhitmore.com/wp-content/uploads/2012/08/chinese-banquet-dinner.jpg"/>
			   
			   <div class="demo">
					<div id="number-callback-demo3" restName='Zhongguo Restaurant' data-number="2"></div>
				</div>
				
			   <p>Description text</p>
			   <p>Location text</p>
			   <p>Price text</p>
			</div>
			

        </div><!-- /content -->
 
    </div><!-- /page -->
	</body>
</html>
